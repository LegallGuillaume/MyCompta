<!--
__author__ = "Le Gall Guillaume"
__copyright__ = "Copyright (C) 2020 Le Gall Guillaume"
__website__ = "www.gyca.fr"
__license__ = "BSD-2"
__version__ = "1.0"
-->
{% extends "body.html" %}

{% block script%}
<script>
    function reload_page()
    {
        document.location.reload(true);
    }

    $(document).ready(function()
    {
        $('#btn_new_invoice').click(function(e)
        {
            $('#newInvoice').modal('hide');
            var objs = {};
            var empty = false
            var l_array = []
            $('#newInvoice :input').each(function()
            {
                if($(this).attr('type') == 'checkbox')
                {
                    objs[$(this).attr('id')] = ($(this).prop('checked') ? 'True' : 'False');
                }
                else if($(this).attr('type') != 'button')
                {
                    var val = $(this).val();
                    if (val == '')
                    {
                        l_array.push($(this).attr('id').replace('-', ' '));
                        empty = true;
                    }
                    objs[$(this).attr('id')] = val;
                }
            });
            if(empty)
            {
                alert('Liste des champs non remplis: ' + l_array);
                return;
            }
            $.ajax({
                method: 'POST',
                url: '/invoices',
                data: objs
            }).done(function()
            {
                $('#newInvoice :input').each(function()
                {
                    if($(this).attr('type') == 'checkbox')
                    {
                        $(this).prop('checked', false);
                    }
                    else if($(this).attr('type') != 'button')
                    {
                        $(this).val('');
                    }
                });
            });
            reload_page();
        });

        $('#confirmModel').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var recipient = button.data('invoicename') // Extract info from data-* attributes
            var modal = $(this);
            modal.find('.modal-body p').text("{{_('And are you sure you want to take out the invoice')}}: " + recipient + ' ?');
            modal.find('#btn_del_invo').data('invoicename', recipient);
        });

        $('#btn_del_invo').click(function()
        {
            var invoicename = $(this).data('invoicename');
            if(invoicename != '')
            {
                remove_invoice(invoicename);
                $(this).data('invoicename', '');
            }

            $('#confirmModel').modal('hide');
            reload_page();
        });

        $(".custom-file-input").on("change", function() {
            var fileName = $(this).val().split('\\').pop();
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });
    });

    function remove_invoice(invoicename)
    {
        $.ajax({
            method: 'POST',
            url: 'invoice-delete',
            data: {'invoice-name' : invoicename}
        }).done(function()
        {
            reload_page();
        });
    }

    function invoice_sold(invoicename, payer)
    {
        $.ajax({
            method: 'POST',
            url: 'invoice-sold',
            data: {'invoice-name' : invoicename, 'invoice-sold' : payer}
        }).done(function()
        {
            reload_page();
        });
    }

</script>
{% endblock%}

{%block body%}

<div class="modal fade" id="newInvoice" tabindex="-1" role="dialog" aria-labelledby="newInvoiceLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="newInvoiceLabel">{{_("New Invoice")}}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <form>
                <div class="form-group">
                    <label for="invoice-name" class="col-form-label">{{_("N° Invoice")}}:</label>
                    <input type="text" disabled value="{{new_invoice}}" class="form-control" id="invoice-name">
                </div>
                <div class="form-group">
                    <label for="invoice-client">{{_("Client")}}:</label>
                    <select class="form-control" id="invoice-client">
                        {%for c in clients%}
                        <option>{{c.name}}</option>
                        {%endfor%}
                    </select>
                </div>
                <div class="form-group">
                    <label for="invoice-project" class="col-form-label">{{_("Project")}}:</label>
                    <input type="text" class="form-control" id="invoice-project">
                </div>
                <div class="form-group">
                    <label for="invoice-day_rate" class="col-form-label">{{_("Day rate")}}:</label>
                    <input type="number" step="0.01" value="300" min="0"  class="form-control" id="invoice-day_rate">
                </div>
                <div class="form-group">
                    <label for="invoice-days" class="col-form-label">{{_("Days")}}:</label>
                    <input type="number" step="1" value="0" min="0" max="31" class="form-control" id="invoice-days">
                </div>
                <div class="form-group">
                    <label for="invoice-datesent" class="col-form-label">{{_("Date sent")}}:</label>
                    <input type="date"  class="form-control" id="invoice-datesent">
                </div>
                <div class="form-group">
                    <label for="invoice-dateexpiry" class="col-form-label">{{_("Date Payment")}}:</label>
                    <input type="date"  class="form-control" id="invoice-dateexpiry">
                </div>
                <div class="form-group">
                    <label for="invoice-delay" class="col-form-label">{{_("Max Delay")}}:</label>
                    <input type="date"  class="form-control" id="invoice-delay">
                </div>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="invoice-tax">
                    <label class="custom-control-label" for="invoice-tax">{{_("incl. Tax")}}</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">{{_("Cancel")}}</button>
            <button type="button" class="btn btn-success" id="btn_new_invoice">{{_("add")}}</button>
        </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmModel" tabindex="-1" role="dialog" aria-labelledby="confirmModelLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmModelLabel">{{_("Confirm !")}}</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body"><p></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">{{_("No")}}</button>
              <button type="button" class="btn btn-danger" id="btn_del_invo" data-invoicename="">{{_("Yes, deleted")}}</button>
            </div>
          </div>
        </div>
      </div>

<div class="row">

    <div class="col-lg-6 my-auto text-center">
        <button type="button" style="width:120px; height:120px;" class="btn btn-outline-success" data-toggle="modal" data-target="#newInvoice"><i style="font-size: 40px" class="fa fa-file-invoice-dollar"></i></button>
    </div>
    {% if not invoices %}
    <div class="col-lg-6"></div>
    {%endif%}
    {%for f in invoices%}
    <div class="col-lg-6">
        <div class="card mb-4 shadow" style="border: 0.10rem solid {{color.col7}}; background-color: transparent;">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" style="color: {{color.col7}}; background-color: {{color.col1}};">
                <div class="row" style="width: 100%;">
                    <div class="col-9 text-left">
                        <h6 class="m-0 font-weight-bold text-white">{{f.name}} - {{get_client_name(f.id_client)}}  <span class="badge {%if f.sold%}badge-success">Payée{%else%}badge-danger">En Attente{%endif%}</span></h6>
                    </div>
                    <div class="col-1">
                        <button class="btn btn-primary btn-circle btn-sm" onclick="window.open(window.location.origin + '/pdf/{{f.name}}', '_blank')">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </div>
                    <div class="col-1">
                        <button class="btn btn-secondary btn-circle btn-sm" onclick="location.href='/invoice/{{f.name}}'">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="col-1">
                        <button data-toggle="modal" data-target="#confirmModel" data-invoicename="{{f.name}}" class="btn btn-danger btn-circle btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-6">
                        <p class="font-weight-bold text-white text-white">{{_("Project")}}: </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-white">{{f.project}}</p>
                    </div>
                </div>
                <div class="row" style="margin-top: -5px;">
                    <div class="col-sm-6">
                        <p class="font-weight-bold text-white">{{_("Date sent")}}: </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-white">{{convert_date(f.date_sent)}}</p>
                    </div>
                </div>
                <div class="row" style="margin-top: -5px;">
                    <div class="col-sm-6">
                        <p class="font-weight-bold text-white">{{_("Days")}}: </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-white">{{f.days}}</p>
                    </div>
                </div>
                <div class="row" style="margin-top: -5px;">
                    <div class="col-sm-6">
                        <p class="font-weight-bold text-white">{{_("Day rate")}}: </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-white">{{f.day_rate}} €</p>
                    </div>
                </div>
                <div class="row" style="margin-top: -5px;">
                    <div class="col-sm-6">
                        <p class="font-weight-bold text-white">{{_("Date Payment")}}: </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-white">{{convert_date(f.max_delay)}}</p>
                    </div>
                </div>
                <div class="row" style="margin-top: -5px;">
                    <div class="col-sm-6">
                        <p class="font-weight-bold text-white">{{_("Invoice of ")}}: </p>
                    </div>
                    <div class="col-sm-6">
                        <p class="text-white">{{f.total}} € <span class="badge badge-pill badge-info">{%if not f.tax%}{{_("without Tax")}}{%else%}{{_("excl. Tax")}}{%endif%}</span></p>
                    </div>
                </div>
                <div class="row">
                    {% if not f.sold %}
                    <div class="col-8 text-center">
                        <a href="/invoices" onclick="invoice_sold('{{f.name}}', 'True');" class="btn btn-danger btn-icon-split">
                            <span class="icon text-white-50">
                                <i class="fas fa-times"></i>
                            </span>
                            <span class="text">{{_("The client hasn't paid")}}</span>
                        </a>
                    </div>
                    {% else %}
                    <div class="col-8 text-center">
                        <a href="/invoices" onclick="invoice_sold('{{f.name}}', 'False');" class="btn btn-success btn-icon-split">
                            <span class="icon text-white-50">
                                <i class="fas fa-check"></i>
                            </span>
                            <span class="text">{{_("The client has paid")}}</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {%endfor%}
</div>

{%endblock%}
